import{r as a,q as D,o as B,c as g,d as f,a as P,s as O,f as G,g as H,h as F,j as s,T as $,w as p,i as L}from"./index-BzMBnkf4.js";import{F as U}from"./PaperAirplaneIcon-Dt3zT8zf.js";function Y({title:t,titleId:o,...r},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":o},r),t?a.createElement("title",{id:o},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.75 3.104v5.714a2.25 2.25 0 0 1-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 0 1 4.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0 1 12 15a9.065 9.065 0 0 0-6.23-.693L5 14.5m14.8.8 1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0 1 12 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"}))}const _=a.forwardRef(Y);function Q({title:t,titleId:o,...r},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":o},r),t?a.createElement("title",{id:o},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"}))}const J=a.forwardRef(Q);function X({title:t,titleId:o,...r},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":o},r),t?a.createElement("title",{id:o},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z"}))}const ee=a.forwardRef(X);async function se(t,o){if(!t)throw new Error("Cannot create session: userId is undefined");const r=new Date,n=i=>i.toString().padStart(2,"0"),l=`${r.getFullYear()}${n(r.getMonth()+1)}${n(r.getDate())}_${n(r.getHours())}${n(r.getMinutes())}${n(r.getSeconds())}`;return await O(G(f,"teleconsultations",l),{userId:t,type:o,status:"open",responder_id:null,createdAt:F()}),l}async function te(t,o){if(!t)throw new Error("Cannot send message: sessionId is undefined");await H(g(f,"teleconsultations",t,"messages"),{sender:"user",text:o,timestamp:F()})}async function ne(t,o){if(!t)throw new Error("Cannot send bot reply: sessionId is undefined");await H(g(f,"teleconsultations",t,"messages"),{sender:"bot",text:o,timestamp:F()})}function ae(t,o){if(!t)throw new Error("Cannot listen to messages: sessionId is undefined");const r=D(g(f,"teleconsultations",t,"messages"),B("timestamp","asc"));return P(r,n=>{const l=n.docs.map(i=>({id:i.id,...i.data()}));o(l)})}async function oe(t,o){if(!t)throw new Error("Cannot update status: sessionId is undefined");await O(G(f,"teleconsultations",t),{status:o},{merge:!0})}async function re(t){const o=$.fromDate(new Date(new Date().setHours(0,0,0,0))),r=$.fromDate(new Date(new Date().setHours(23,59,59,999))),n=D(g(f,"teleconsultations"),p("userId","==",t),p("status","in",["open","active"]),p("createdAt",">=",o),p("createdAt","<=",r)),l=await L(n);if(!l.empty){const i=l.docs[0];return{id:i.id,...i.data()}}return null}async function le(t){const o=D(g(f,"teleconsultations"),p("userId","==",t),p("status","==","closed"),B("createdAt","desc"));return(await L(o)).docs.map(n=>({id:n.id,...n.data()}))}function de({userId:t}){const[o,r]=a.useState("General"),[n,l]=a.useState(null),[i,h]=a.useState("closed"),[m,v]=a.useState(""),[S,y]=a.useState([]),[d,u]=a.useState(!1),[M,q]=a.useState([]),[w,N]=a.useState(!1),[I,b]=a.useState(!1),[C,k]=a.useState(null),j=a.useRef(null),A=a.useRef(null),V=[{name:"General",icon:s.jsx(J,{className:"w-6 h-6"})},{name:"Medicine Question",icon:s.jsx(_,{className:"w-6 h-6"})},{name:"Symptom Advice",icon:s.jsx(ee,{className:"w-6 h-6"})}];a.useEffect(()=>{async function e(){try{const c=await re(t);c?(l(c.id),h(c.status),r(c.type||"General")):(h("closed"),r("General"));const x=await le(t);q(x)}catch(c){console.error("Failed to fetch sessions:",c)}}e()},[t]),a.useEffect(()=>{if(!n||w)return;const e=ae(n,y);return()=>e()},[n,w]),a.useEffect(()=>{j.current&&(j.current.scrollTop=j.current.scrollHeight)},[S]),a.useEffect(()=>{if(!A.current)return;const e=A.current;e.style.height="auto",e.style.height=`${Math.min(e.scrollHeight,96)}px`},[m]);const W=async()=>{if(!(d||n)){u(!0);try{const e=await se(t,o);l(e),h("open")}catch(e){console.error("Failed to create session:",e)}finally{u(!1),b(!1),k(null)}}},Z=async()=>{if(n){u(!0);try{await oe(n,"closed"),l(null),y([]),v(""),h("closed"),r("General"),N(!1)}catch(e){console.error("Failed to end session:",e)}finally{u(!1),b(!1),k(null)}}},R=async()=>{if(!(!m.trim()||!n)){u(!0);try{await te(n,m),v(""),S.some(c=>c.sender==="bot")?u(!1):setTimeout(async()=>{try{await ne(n,"Thanks for your message. Our support personnel will assist you shortly.")}catch(c){console.error("Bot reply failed:",c)}finally{u(!1)}},1500)}catch(e){console.error("sendUserMessage failed:",e),u(!1)}}},z=async e=>{l(e),N(!0),h("closed");const c=await L(g(f,"teleconsultations",e,"messages"));y(c.docs.map(x=>{const E=x.data();return{id:x.id,sender:E.sender??"user",text:E.text??"",timestamp:E.timestamp??null}}))},K=()=>{l(null),y([]),N(!1),h("closed")},T=e=>{k(e),b(!0)};return s.jsxs("div",{className:"flex flex-1 h-full flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsx("h1",{className:"text-xl font-semibold text-[#0F8A69]",children:"Teleconsultation"}),w&&s.jsx("button",{onClick:K,className:"text-[#0F8A69] hover:text-[#0c7356] font-medium",children:"â† Back"})]}),i==="closed"&&!n&&!w&&s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold text-[#0F8A69] mb-4",children:"Select Consultation Type"}),s.jsx("div",{className:"grid grid-cols-3 gap-4 mb-4",children:V.map(e=>s.jsxs("button",{onClick:()=>r(e.name),className:`flex flex-col items-center justify-center py-10 rounded-lg transition
                  ${o===e.name?"bg-[#0F8A69] text-white":"bg-white text-[#0F8A69]"}`,children:[e.icon,s.jsx("span",{className:"mt-1 font-medium text-sm",children:e.name})]},e.name))}),s.jsx("button",{onClick:()=>T("start"),disabled:d,className:"w-full bg-[#0F8A69] text-white py-3 rounded-lg font-medium hover:bg-[#0c7356] disabled:opacity-50",children:"Start Teleconsultation"}),s.jsxs("div",{className:"mt-6",children:[s.jsx("h2",{className:"text-lg font-medium mb-2",children:"Past Sessions"}),M.length===0&&s.jsx("p",{className:"text-gray-500",children:"No past sessions."}),s.jsx("div",{className:"space-y-3",children:M.map(e=>{const x=(e.createdAt?.toDate?e.createdAt.toDate():new Date).toLocaleString();return s.jsx("button",{onClick:()=>z(e.id),className:"w-full text-left border p-3 rounded-lg hover:bg-gray-100",children:s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("span",{children:[e.type||"General"," - ",e.id.slice(-6)]}),s.jsx("span",{className:"text-gray-500 text-sm",children:x})]})},e.id)})})]})]}),(i==="open"||i==="active"||n)&&s.jsxs("div",{className:"flex flex-col flex-1 min-h-0 mb-4",children:[s.jsx("div",{ref:j,className:"flex-1 bg-white rounded-xl shadow-md p-6 space-y-4 overflow-y-auto",children:S.map(e=>s.jsx("div",{children:s.jsx("div",{className:`flex ${e.sender==="user"?"justify-end":"justify-start"}`,children:s.jsx("div",{className:`p-4 rounded-xl max-w-xs break-words whitespace-pre-wrap ${e.sender==="user"?"bg-[#0F8A69] text-white":e.sender==="doctor"?"bg-blue-200 text-blue-900":"bg-gray-200 text-gray-700"}`,children:e.text})})},e.id))}),i!=="closed"&&!w&&s.jsxs("div",{className:"relative flex items-center space-x-3 pt-4 shrink-0",children:[s.jsx("textarea",{ref:A,placeholder:"Write a message",value:m,onChange:e=>v(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&!d&&m.trim()&&(e.preventDefault(),R())},rows:1,style:{resize:"none",overflow:"auto",maxHeight:"6rem"},className:"flex-1 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#0F8A69]"}),s.jsx("button",{onClick:R,disabled:d||!m.trim(),className:`bg-[#0F8A69] p-3 rounded-lg text-white hover:bg-[#0c7356] ${d||!m.trim()?"opacity-50 cursor-not-allowed":""}`,children:s.jsx(U,{className:"w-6 h-6 rotate-45"})}),s.jsx("button",{onClick:()=>T("end"),className:"bg-red-500 p-3 rounded-lg text-white hover:bg-red-600",children:"End Session"})]})]}),I&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white w-full max-w-sm p-6 rounded-xl shadow-lg",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:C==="start"?"Start Teleconsultation":"End Session"}),s.jsx("p",{className:"mb-6 text-gray-700",children:C==="start"?"Are you sure you want to start a new teleconsultation?":"Are you sure you want to end this session? You won't be able to send messages after ending."}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{onClick:()=>b(!1),className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100",disabled:d,children:"Cancel"}),s.jsx("button",{onClick:C==="start"?W:Z,className:"px-4 py-2 rounded-lg bg-[#0F8A69] text-white hover:bg-[#0c7356]",disabled:d,children:d?"Processing...":"Confirm"})]})]})})]})}export{de as default,le as getClosedSessions,re as getTodaySession};
